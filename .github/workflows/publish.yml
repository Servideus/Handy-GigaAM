name: Publish

on:
  workflow_dispatch:
  push:
    branches:
      - release

permissions:
  contents: write

jobs:
  publish-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: ""
            args: ""
          - os: ubuntu-22.04
            target: ""
            args: ""
          - os: macos-latest
            target: x86_64-apple-darwin
            args: --target x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
            args: --target aarch64-apple-darwin
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect package manager
        id: pm
        shell: bash
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> "$GITHUB_OUTPUT"
            echo "lockfile=pnpm-lock.yaml" >> "$GITHUB_OUTPUT"
            echo "install_cmd=pnpm install --frozen-lockfile" >> "$GITHUB_OUTPUT"
            echo "cache=pnpm" >> "$GITHUB_OUTPUT"
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> "$GITHUB_OUTPUT"
            echo "lockfile=yarn.lock" >> "$GITHUB_OUTPUT"
            echo "install_cmd=yarn install --frozen-lockfile" >> "$GITHUB_OUTPUT"
            echo "cache=yarn" >> "$GITHUB_OUTPUT"
          elif [ -f package-lock.json ]; then
            echo "manager=npm" >> "$GITHUB_OUTPUT"
            echo "lockfile=package-lock.json" >> "$GITHUB_OUTPUT"
            echo "install_cmd=npm ci" >> "$GITHUB_OUTPUT"
            echo "cache=npm" >> "$GITHUB_OUTPUT"
          elif [ -f bun.lockb ] || [ -f bun.lock ]; then
            echo "manager=bun" >> "$GITHUB_OUTPUT"
            if [ -f bun.lockb ]; then
              echo "lockfile=bun.lockb" >> "$GITHUB_OUTPUT"
            else
              echo "lockfile=bun.lock" >> "$GITHUB_OUTPUT"
            fi
            echo "install_cmd=bun install --frozen-lockfile" >> "$GITHUB_OUTPUT"
          else
            echo "No supported lockfile found (pnpm-lock.yaml, yarn.lock, package-lock.json, bun.lock/bun.lockb)." >&2
            exit 1
          fi

      - name: Setup Node.js
        if: steps.pm.outputs.manager != 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: ${{ steps.pm.outputs.cache }}
          cache-dependency-path: ${{ steps.pm.outputs.lockfile }}

      - name: Setup Node.js (bun projects)
        if: steps.pm.outputs.manager == 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Corepack
        if: steps.pm.outputs.manager == 'pnpm' || steps.pm.outputs.manager == 'yarn'
        run: corepack enable

      - name: Setup Bun
        if: steps.pm.outputs.manager == 'bun'
        uses: oven-sh/setup-bun@v2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust target (macOS)
        if: matrix.target != ''
        run: rustup target add ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"
          key: ${{ matrix.os }}-${{ matrix.target }}

      - name: Configure libclang path (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (Test-Path "C:\Program Files\LLVM\bin\libclang.dll") {
            "LIBCLANG_PATH=C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: Install Vulkan SDK (Windows)
        if: matrix.os == 'windows-latest'
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          version: 1.4.309.0
          cache: true

      - name: Install Windows bundler tools
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install -y nsis wixtoolset

      - name: Install dependencies (ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev librsvg2-dev patchelf libgtk-3-dev libasound2-dev libopenblas-dev libx11-dev libxtst-dev libxrandr-dev libgtk-layer-shell-dev libvulkan-dev mesa-vulkan-drivers
          sudo apt-get install -y libappindicator3-dev || sudo apt-get install -y libayatana-appindicator3-dev

      - name: Prepare Vulkan SDK (ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
          sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-1.3.290-jammy.list https://packages.lunarg.com/vulkan/1.3.290/lunarg-vulkan-1.3.290-jammy.list
          sudo apt-get update
          sudo apt-get install -y vulkan-sdk mesa-vulkan-drivers

      - name: Install frontend dependencies
        run: ${{ steps.pm.outputs.install_cmd }}

      - name: Disable updater artifacts when signing key is missing
        shell: bash
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          if [ -z "$TAURI_SIGNING_PRIVATE_KEY" ]; then
            node -e "const fs=require('fs');const p='src-tauri/tauri.conf.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));let changed=false;if(j.bundle?.createUpdaterArtifacts){j.bundle.createUpdaterArtifacts=false;changed=true;}if(j.bundle?.windows?.signCommand){delete j.bundle.windows.signCommand;changed=true;}if(changed){fs.writeFileSync(p,JSON.stringify(j,null,2)+'\\n');console.log('Disabled updater artifacts and Windows signCommand for unsigned CI release build.');}"
          else
            echo "TAURI_SIGNING_PRIVATE_KEY is set; keeping createUpdaterArtifacts enabled."
          fi

      - name: Build and publish installers
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WHISPER_NO_AVX: ${{ matrix.os == 'ubuntu-22.04' && 'ON' || '' }}
          WHISPER_NO_AVX2: ${{ matrix.os == 'ubuntu-22.04' && 'ON' || '' }}
        with:
          tagName: app-v__VERSION__
          releaseName: Handy v__VERSION__
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}
